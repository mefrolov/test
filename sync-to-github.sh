#!/bin/bash

# –ü—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å GitHub
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∫–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏ public –≤ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å GitHub..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∞–ø–∫–∞ public —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d "public" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ø–∞–ø–∫–∞ 'public' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    echo "–°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É 'public' –∏ –ø–æ–º–µ—Å—Ç–∏—Ç–µ —Ç—É–¥–∞ —Ñ–∞–π–ª—ã –¥–ª—è –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ñ–∞–π–ª—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
if [ -z "$(ls -A public)" ]; then
    echo "‚ö†Ô∏è  –ü–∞–ø–∫–∞ 'public' –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: $LAST_COMMIT_MSG"

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
TEMP_DIR="temp_github_sync"
mkdir -p "$TEMP_DIR"

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ public –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
echo "üìÅ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏–∑ public/..."
cp -r public/* "$TEMP_DIR/"

# –ö–ª–æ–Ω–∏—Ä—É–µ–º GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
echo "üì• –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é..."
git clone $(git remote get-url github) "$TEMP_DIR/github_repo"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
cd "$TEMP_DIR/github_repo"

# –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∫—Ä–æ–º–µ .git (—á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –Ω–æ–≤—ã–µ)
find . -maxdepth 1 ! -name '.' ! -name '.git' -exec rm -rf {} + 2>/dev/null

# –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–∑ public
echo "üìã –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏..."
cp -r ../* . 2>/dev/null
rm -rf github_repo 2>/dev/null  # –£–¥–∞–ª—è–µ–º –≤–ª–æ–∂–µ–Ω–Ω—É—é –∫–æ–ø–∏—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if git diff --quiet && git diff --staged --quiet; then
    echo "‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
    cd ../..
    rm -rf "$TEMP_DIR"
    exit 0
fi

# –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git add .

# –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
echo "üíæ –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç..."
git commit -m "üìä $LAST_COMMIT_MSG

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
–î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M:%S')"

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GitHub
echo "üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ GitHub..."
git push origin main

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∏—Å—Ö–æ–¥–Ω—É—é –ø–∞–ø–∫—É –∏ —É–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
cd ../..
rm -rf "$TEMP_DIR"

echo "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à GitHub: $(git remote get-url github)"